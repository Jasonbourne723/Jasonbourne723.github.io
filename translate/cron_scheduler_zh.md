在Nextdoor，我们为各种各样的重要目的运行了大量的调度任务，例如 每天给我们的用户发送千万的数字邮件，为我们的团队生成内部报告和一些操作性任务。和很多其他的互联网公司一样，我们从cron开始，并最终构建了我们自己的cron项目-Nextdoor 调度。

我们使用了 Nextdoor调度超过18个月，并且对它很满意。

那么，cron有什么问题呢？
cron 有四个主要的问题。
首先，我们使用cron的方式没有扩展性，我们运行所有的cron jobs在一台调度机器上，cronjobs会将机器的计算资源推到它的极限。

第二点，编辑朴素文本管理job是容易出错的，例如，新增、删除、暂停任务，对一个实例来说，一个额外的星号阻止前几天所有任务的运行。

第三点，我们有大约200个生产任务，每天执行几千次在不同的频率，job运行失败是普遍现象，
oncall人员不得不每天手动重启几次失败的任务，有时候在半夜，这里有一个典型的oncall经验例子：
1. 获取到失败任务的命令文件
2. ssh进入到调度机器
3. 复制粘贴命令重启失败任务
这很影响工程师幸福度，是的，我们很关心员工的幸福度。

第四点，生产job在运行时存在一些小的变量，我们很难知道job在运行或者说运行是否成功。

够了，我们决定搭建一个cron的替代品，但为什么我们不使用开源的解决方案呢？我们刚好没有找到合适的那个，我们使用python，我们想要充分利用公司内已存在的基础组件，我们想要搭建他，理解它，拥有它。

为了追踪可扩展的议题，我们让每个job异步运行在集群的taskworker机器，我们仅需要一行代码的修改就可以轻松为运行在taskworker上的job失败自动重启，我们的oncall工程师非常喜欢这个自动重启功能。

为了替换cron，我们使用能够是我们程序化管理job的python模块 apscheduler去调度任务，我们构建restapi、命令行工具和友好的web界面。

接下来的图片展示了我们调度系统的架构。

调度器使用python/tornado实现，它由三个组件组成作为守护进程运行在单一的机器上，
1. 调度器，他替换cron并且调度job运行，当一个job触发运行，调度器程序简单发布一个消息到AmazonSQS，taskworker集群机器会从sqs中抓消息，并运行job，为了，，我们使用apscheduler实现核心调度。
2. 调度器接口，提供了管理job的rest接口，增加job、暂停job、恢复job、删除job、修改job、手动下掉job，我们构建了命令行工具基于调度接口使操作更加简单，例如，一次暂停一组job。
3. web界面，是一个访问调度接口的单页面程序，我们使用backbone.js和bootstrap去实现界面，使用者主要使用web界面去使用调度器。

所有job和job运行的信息都保存在一个数据库中，我们主要使用postgres。

工程师喜欢调度系统的web界面，它提供了直面化的管理方式，相比于过去使用cron的黑盒操作。

